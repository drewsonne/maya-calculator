<!doctype html>
<html lang="en_UK">
<head>
    <script src="js/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/bootstrap.js"></script>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <style>
        /*.row {*/
        /*    display: flex;*/
        /*}*/

        /*#instructions {*/
        /*    flex: 10%;*/
        /*    padding-top: 20px;*/
        /*}*/

        /*#calendar_input {*/
        /*    flex: 30%;*/
        /*    margin-top: 20px;*/
        /*    min-width: 150px;*/
        /*}*/

        /*#longcount_output {*/
        /*    flex: 55%;*/
        /*    padding-right: 20px;*/
        /*    padding-top: 20px;*/
        /*}*/

        #longcount_output, #calendar_input {
            text-align: right;
        }

        /*textarea, input, button, select {*/
        /*    font-family: inherit;*/
        /*    font-size: inherit;*/
        /*}*/

        .monospace {
            font-family: monospace;
            font-size: 150%;
        }

        /*.calendar_round {*/
        /*    min-width: 100px;*/
        /*}*/
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row monospace">
    <textarea class="col" id="calendar_input" rows="25">
    </textarea>

        <div class="col-8" id="longcount_output">
        </div>
    </div>
</div>

</body>
<script type="application/javascript">

  class MayaCalculator {
    constructor () {
      this.operands = []
      this.current_raw_line = ''
      this.ledger = []
    }

    evaluate (raw_input) {
      let operations = raw_input.split(/\n/)
      if (operations.length > 0) {
        this.operands = []
        this.ledger = []
        let operation_length = operations.length
        let result
        for (let i = 0; i < operation_length; i++) {
          let line = operations[i].replace(/[.+\-]$/, '')
          this.fetch(line)
          this.decode()
          result = this.execute()
          if (result !== undefined) {
            operations.splice(
              i + 1,
              0,
              result.toString().replace(/\s+/g, ''),
            )
            operation_length = operations.length
          }
        }
      }
      console.log(this.operands)
      console.log(this.ledger)
      return this.ledger
    }

    fetch (raw_line) {
      this.current_raw_line = raw_line
    }

    decode () {
      if (this.current_raw_line.length > 1) {
        let operand
        if (Boolean(
          this.current_raw_line[0] === '-' |
          this.current_raw_line[0] === '+',
        )) {
          operand = new DistanceNumber(this.current_raw_line)
          operand.add_long_count(this.operands[this.operands.length - 1])
        } else {
          operand = new LongCount(this.current_raw_line)
        }

        this.operands.push(operand)
      }
      this.current_raw_line = ''
    }

    execute () {
      let result
      if (this.operands.length > 0) {
        this.ledger = $.merge(
          this.ledger,
          this.operands[this.operands.length - 1].spans(),
        )
        result = this.operands[this.operands.length - 1].compute()
      }
      // this.operands = []
      return result
    }
  }

  class MayaDate {
    constructor (raw) {
      this.raw = raw.trim().replace(/[^\d.]+/, '').replace(/[\.\+]$/, '')
      this.parts = this.raw.split('.').reverse()
    }

    compute () {
      return undefined
    }

    get_date_sections (number) {
      let part = this.parts[number]
      if (part === undefined) {
        return 0
      }
      return parseInt(part)
    }

    set_date_sections (number, value) {
      this.parts[number] = value.toString()
      this.raw = this.toString()
    }

    set k_in (new_k_in) {
      this.set_date_sections(0, new_k_in)
    }

    get k_in () {
      return this.get_date_sections(0)
    }

    set winal (new_winal) {
      this.set_date_sections(1, new_winal)
    }

    get winal () {
      return this.get_date_sections(1)
    }

    set tun (new_tun) {
      this.set_date_sections(2, new_tun)
    }

    get tun () {
      return this.get_date_sections(2)
    }

    set k_atun (new_k_atun) {
      this.set_date_sections(3, new_k_atun)
    }

    get k_atun () {
      return this.get_date_sections(3)
    }

    set bak_tun (new_bak_tun) {
      this.set_date_sections(4, new_bak_tun)
    }

    get bak_tun () {
      return this.get_date_sections(4)
    }

    set piktun (new_bak_tun) {
      this.set_date_sections(5, new_bak_tun)
    }

    get piktun () {
      return this.get_date_sections(5)
    }

    set kalabtun (new_bak_tun) {
      this.set_date_sections(6, new_bak_tun)
    }

    get kalabtun () {
      return this.get_date_sections(6)
    }

    set kinchiltun (new_bak_tun) {
      this.set_date_sections(7, new_bak_tun)
    }

    get kinchiltun () {
      return this.get_date_sections(7)
    }

    total_k_in () {
      return this.k_in +
        this.winal * 20 +
        this.tun * 360 +
        this.k_atun * 7200 +
        this.bak_tun * 144000 +
        this.piktun * 2880000 +
        this.kalabtun * 57600000 +
        this.kinchiltun * 1152000000
    }

    normalised_date_from_k_in (total_k_in) {
      let new_date = new LongCount('')
      new_date.k_in = total_k_in % 20
      new_date.winal = (total_k_in - new_date.total_k_in()) / 20 % 18
      new_date.tun = (total_k_in - new_date.total_k_in()) / 360 % 20
      new_date.k_atun = (total_k_in - new_date.total_k_in()) / 7200 % 20
      new_date.bak_tun = (total_k_in - new_date.total_k_in()) / 144000 % 20
      new_date.piktun = (total_k_in - new_date.total_k_in()) / 2880000 % 20
      new_date.kalabtun = (total_k_in - new_date.total_k_in()) / 57600000 % 20
      new_date.kinchiltun = (total_k_in - new_date.total_k_in()) / 1152000000 %
        20
      return new_date
    }

    toString () {
      let parts = this.parts.slice().reverse()
      let part
      let significant_digits = []
      for (let i = 0; i < parts.length; i++) {
        part = parts[i]
        if (part !== '0') {
          significant_digits = parts.slice(i)
          break
        }
      }

      for (let i = 0; i < significant_digits.length; i++) {
        significant_digits[i] = significant_digits[i].toString()
        if (significant_digits[i].length < 2) {
          significant_digits[i] = ' ' + significant_digits[i]
        }
      }
      return significant_digits.join('.')
    }
  }

  class LongCount extends MayaDate {

    constructor (raw) {
      super(raw)
      this.date_pattern = /(\d+\.?)+/
    }

    is_valid () {
      return this.date_pattern.test(this.toString())
    }

    spans () {
      return $(
        '<div class="row">' +
        '<div class="col-8 calendar_round">' +
        new CalendarRound(this.total_k_in()) +
        '</div>' +
        '<div class="col">' + this.toString() + '</div>',
        '</div>',
      )
    }
  }

  class DistanceNumber extends MayaDate {
    constructor (raw) {
      super(raw)
      if (raw.length > 1) {
        this.sign = (raw[0] === '+') ? 1 : -1
      }
      this.long_count = undefined
    }

    add_long_count (long_count) {
      this.long_count = long_count
    }

    compute () {
      let result = this.long_count.total_k_in() +
        (this.total_k_in() * this.sign)

      return this.normalised_date_from_k_in(result)
    }

    spans () {
      let distance_string = (this.sign === 1 ? '+' : '-') + this.toString()
      let separator_length = Math.max(
        distance_string.length,
        this.long_count.toString().length,
      )

      return $(
        '<div class="row">' +
        '<div class="col-8"></div>' +
        '<div class="col">' + distance_string + '</div><br/>' +
        '</div>' +
        '<div class="row">' +
        '<div class="col-8"></div>' +
        '<div class="col">' + '-'.repeat(separator_length) + '</div><br/>' +
        '</div>',
      )

    }

  }

  class CalendarRound {
    constructor (total_days) {
      this.total_days = total_days
      this.tzolk_in_lookup = {
        0: 'Ajaw',
        1: 'Imix',
        2: 'Ik\'',
        3: 'Ak\'bal',
        4: 'K\'an',
        5: 'Chikchan',
        6: 'Kimi',
        7: 'Manik',
        8: 'Lamat',
        9: 'Muluk',
        10: 'Ok',
        11: 'Chuwen',
        12: 'Eb',
        13: 'Ben',
        14: 'Ix',
        15: 'Men',
        16: 'Kib',
        17: 'Kaban',
        18: 'Etz\'nab',
        19: 'Kawak',
      }
      this.haab_lookup = {
        1: 'Pop',
        2: 'Wo',
        3: 'Sip',
        4: 'Sotz\'',
        5: 'Sek',
        6: 'Xul',
        7: 'Yaxk\'in',
        8: 'Mol',
        9: 'Ch\'en',
        10: 'Yax',
        11: 'Sak',
        12: 'Keh',
        13: 'Mak',
        14: 'K\'ank\'in',
        15: 'Muwan',
        16: 'Pax',
        17: 'K\'ayab',
        18: 'Kumk\'u',
        19: 'Wayeb',
      }
    }

    get tzolk_in_coeff () {
      return (4 + this.total_days) % 13
    }

    get tzolk_in () {
      return this.tzolk_in_coeff.toString() + ' ' +
        this.tzolk_in_lookup[this.total_days % 20]
    }

    get haab_coeff () {
      let day_in_haab = (this.total_days - 17) % 365
      return day_in_haab % 20
    }

    get haab () {
      let day_in_haab = (this.total_days - 17) % 365
      return this.haab_coeff.toString() + ' ' +
        this.haab_lookup[Math.ceil(day_in_haab / 20)]
    }

    toString () {
      return this.tzolk_in + ' ' + this.haab + ' '
    }

  }

  $(document).ready(function () {
    const calculator = new MayaCalculator()
    let input = $('#calendar_input')
    let output = $('#longcount_output')

    input.keyup(function (event) {
      let raw_calculations = input.val().trim()
      let results = calculator.evaluate(raw_calculations)
      output.html(results)
    })
  })
</script>
</html>
